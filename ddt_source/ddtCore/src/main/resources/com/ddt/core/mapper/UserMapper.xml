<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ddt.core.mapper.UserMapper">
    
    <sql id="user_base_column">
          id	id
        , user_name	userName
        , password	password
        , wx_number	wxName
        , mobile	mobile
        , group_id	groupId
        , create_time	createTime
    </sql>
    
    <sql id="wx_user_base_column">
          id	id
        , user_name	userName
        , wx_number	wxName
        , mobile	mobile
        , create_time	createTime
    </sql>
    
    <select id="getUserByName" resultType="User" parameterType="string">
        SELECT
        <include refid="user_base_column"/>
        FROM	ddt_user
        WHERE	user_name = #{username}
    </select>
    
    <select id="getWxUserByName" resultType="User" parameterType="string">
        SELECT
        <include refid="wx_user_base_column"/>
        FROM	ddt_wx_user
        WHERE	user_name = #{username}
    </select>
    
    <insert id="insertUser" parameterType="User" keyColumn="id" keyProperty="id">
        <selectKey keyProperty="id" resultType="long">
			SELECT LAST_INSERT_ID() AS id FROM dual
		</selectKey>
		INSERT INTO ddt_user(id, user_name, password, wx_number, mobile, group_id, create_time)
		VALUES(#{id}, #{userName}, #{password}, #{wxName}, #{mobile}, #{groupId}, NOW())
    </insert>
    
     <insert id="insertWxUser" parameterType="User" keyColumn="id" keyProperty="id">
        <selectKey keyProperty="id" resultType="long">
			SELECT LAST_INSERT_ID() AS id FROM dual
		</selectKey>
		INSERT INTO ddt_wx_user(id, user_name, wx_number, mobile, create_time)
		VALUES(#{id}, #{userName}, #{wxName}, #{mobile}, NOW())
    </insert>
    
    <select id="getUserRoles" parameterType="java.util.Map" resultType="Role">
        SELECT	  a.id	id
        		, a.name	name
        FROM	  ddt_role a
        		, ddt_user_role b
        WHERE	a.id = b.role_id
        		AND b.user_id = #{id}
    </select>
    
    <update id="updateUser" parameterType="User">
        UPDATE	  ddt_user
        SET		  user_name = #{userName}
        		, password = #{password}
		        , wx_number = #{wxName}
		        , mobile = #{mobile}
		        , group_id = #{groupId}
		WHERE	id = #{id}
    </update>
    
    <select id="getRollBookUserList" parameterType="java.util.Map" resultType="User">
        SELECT
        <include refid="user_base_column"/>
        FROM	ddt_user
        WHERE	group_id = #{groupId}
        <if test="limit > 0">
            LIMIT #{limit}
            OFFSET	#{offset}
        </if>
    </select>
    
    <delete id="deleteUserById" parameterType="java.util.Map">
        DELETE FROM ddt_user WHERE id = #{id}
    </delete>
</mapper>